from abc import ABC, abstractmethod
from pathlib import Path
from typing import Optional

from numpy import ndarray

from ..settings import VideoCoreConfig


class BaseDecoder(ABC):
    """
        Базовый интерфейс для всех видео-декодеров.
        Каждый декодер обязан:
        * уметь открывать и закрывать источник;
        * выдавать корректные метаданные (fps, total_frames);
        * выполнять seek по кадру;
        * читать кадры последовательно;
        * сообщать текущий индекс кадра.
    """
    def __init__(self, path: str, config: VideoCoreConfig):
        self._path: Path = Path(path).expanduser().resolve()
        self._config: VideoCoreConfig = config

        # Текущий кадр
        self._current_frame_id: int = 0

        # Метаданные видео (инициализируются при open())
        self._fps: Optional[float] = None
        self._total_frames: Optional[int] = None

    # ---------------------------------------------------------
    # Lifecycle
    # ---------------------------------------------------------

    def _init_metadata(self) -> None:
        """
            Инициализация метаданных видео:
            fps, total_frames и т.д.
            Реализуется в каждом декодере индивидуально.
        """
        raise NotImplementedError

    @abstractmethod
    def open(self) -> bool:
        """ Открывает источник (файл, поток, камеру). """
        pass

    @abstractmethod
    def close(self) -> None:
        """ Закрывает источник и освобождает ресурсы. """
        pass

    # ---------------------------------------------------------
    # Metadata
    # ---------------------------------------------------------

    @abstractmethod
    def get_total_frames(self) -> int:
        "" "Возвращает общее количество кадров (или 0, если неизвестно). """
        pass

    @abstractmethod
    def get_fps(self) -> float:
        """ Возвращает FPS (или 0.0, если неизвестно). """
        pass

    # ---------------------------------------------------------
    # Navigation
    # ---------------------------------------------------------

    @abstractmethod
    def seek(self, frame_index: int) -> None:
        """ Прыжок к указанному кадру (индексному). """
        pass

    def cur_frame_id(self) -> int:
        raise NotImplementedError

    # ---------------------------------------------------------
    # Reading
    # ---------------------------------------------------------

    @abstractmethod
    def read(self) -> Optional[ndarray]:
        """ Читает следующий кадр. Возвращает None при достижении конца видео. """
        pass

    # ---------------------------------------------------------
    # Common for all decoders
    # ---------------------------------------------------------
    @property
    def fps(self) -> Optional[float]:
        """
            Статический FPS, полученный из контейнера или устройства.

            Назначение:
            -----------
            Используется для:
            * временной шкалы (timeline),
            * корректного seek,
            * вычисления положения в секундах.

            Особенности:
            ------------
            Это НЕ реальный FPS потокового источника.
            Для live-stream (RTSP, камеры) это значение может быть:
            * недоступным,
            * некорректным,
            * отличаться от фактического FPS.

            Реальный FPS необходимо вычислять вручную — см. measure_fps().
        """
        return self._fps

    @property
    def total_frames(self) -> Optional[int]:
        """
            Статическое количество кадров, предоставленное контейнером.

            Назначение:
            -----------
            Используется для:
            * проверки границ seek,
            * вычисления прогресса,
            * UI отображения.

            Особенности:
            ------------
            Для видеопотоков (стримов) это значение может быть отсутствующим.
            Для некоторых контейнеров OpenCV может предоставлять неверные данные.

            Значение инициализируется в момент вызова open().
        """
        return self._total_frames

    def measure_fps(self, window_seconds: float = 1.0) -> float:
        """
            Измеряет реальный FPS потокового источника за указанное окно времени.

            Назначение:
            -----------
            Эта функция предназначена для получения *фактической скорости кадров*,
            особенно для:
            * камер,
            * RTSP потоков,
            * IP-камер,
            * нестабильных источников с плавающим FPS.

            Почему measure_fps НЕ является частью базовой логики:
            ------------------------------------------------------
            * Реальный FPS НЕ используется в seek.
            * Реальный FPS НЕ используется в таймлайне.
            * Это отдельный аналитический инструмент:
                - диагностика задержек,
                - обнаружение пропусков кадров,
                - мониторинг производительности.

            Текущая реализация:
            -------------------
            Заглушка. Конкретные декодеры (например, OpenCVDecoder)
            могут переопределить этот метод и дать реальную логику.

            :param window_seconds: временное окно для измерения FPS.
            :return: реальный FPS (float)
        """
        # Пока возвращаем статический FPS.
        # Реализуется конкретным декодером, если потребуется.
        return self._fps or 0.0

    def clamp_frame_index(self, frame_index: int) -> int:
        """
            Ограничивает индекс кадра допустимым диапазоном.
            ---------
            1. Если frame_index < 0 — возвращаем 0.
            2. Если total_frames не определён (None), либо отрицательный —
               возвращаем index как есть (но не меньше 0).
               *Причина:* невозможно корректно ограничить диапазон без знания длины видео.
            3. Если total_frames == 0 — возвращаем 0 (видео нулевой длины, остаёмся в начале).
            4. Если frame_index >= total_frames — возвращаем total_frames - 1.
            5. Во всех остальных случаях — возвращаем frame_index как есть.
        """

        # Нижняя граница
        if frame_index < 0:
            return 0

        # Если total_frames неизвестен или некорректен, мы не можем ограничить верхнюю границу — возвращаем как есть.
        # Но обязательно гарантируем, что index >= 0.
        if self._total_frames is None or self._total_frames < 0:
            return frame_index

        # Видео длиной 0 кадров, то единственная возможная позиция — 0
        if self._total_frames == 0:
            return 0

        # Верхняя граница
        if frame_index >= self._total_frames:
            return self._total_frames - 1

        # Корректный диапазон
        return frame_index
